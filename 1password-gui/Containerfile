FROM baseimage

RUN <<EORUN
set -xeuo pipefail

# Download and extract tarball (supports both x86_64 and aarch64)
curl -fL "https://downloads.1password.com/linux/tar/stable/$(uname -m)/1password-latest.tar.gz" -o /tmp/1password.tar.gz
mkdir -p /usr/lib/1Password
tar -xzf /tmp/1password.tar.gz -C /usr/lib/1Password --strip-components=1

# Run after-install script for desktop integration
bash /usr/lib/1Password/after-install.sh

# Create symlinks
ln -sf /usr/lib/1Password/1password /usr/bin/1password
ln -sf /usr/lib/1Password/1Password-BrowserSupport /usr/bin/1Password-BrowserSupport
ln -sf /usr/lib/1Password/1Password-Crash-Handler /usr/bin/1Password-Crash-Handler

# Set chrome-sandbox permissions
chmod 4755 /usr/lib/1Password/chrome-sandbox

# Fix desktop file paths
sed -i 's|^Exec=/opt/1Password|Exec=/usr/bin|g' /usr/share/applications/1password.desktop

# Create sysusers.d config for browser integration group
mkdir -p /usr/lib/sysusers.d
echo 'g onepassword -' > /usr/lib/sysusers.d/1password.conf

# Create tmpfiles.d config to copy BrowserSupport with setgid permissions
# This runs at boot after sysusers.d creates the group
mkdir -p /usr/lib/tmpfiles.d
cat > /usr/lib/tmpfiles.d/1password.conf << 'EOF'
# Copy BrowserSupport binary with setgid for browser integration
d /var/lib/1password 0755 root root -
C /var/lib/1password/1Password-BrowserSupport 2755 root onepassword - /usr/lib/1Password/1Password-BrowserSupport
EOF

# Cleanup
rm -f /tmp/1password.tar.gz
EORUN
